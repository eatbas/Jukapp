<% content_for :title, "History" %>

<% content_for :menu_button do %>
  <core-icon icon="menu"></core-icon>
<% end %>

<div style="display: none;">
  Played
  <% if params[:sort] == "played_at" %>
    <%= link_to stats_path, class: "btn btn-default btn-xs" do %>
      <span class="glyphicon glyphicon-chevron-down"></span>
    <% end %>
  <% end %>
</div>
<div style="display: none;">
  Last played
  <% unless params[:sort] == "played_at" %>
    <%= link_to stats_path(sort: "played_at"), class: "btn btn-default btn-xs" do %>
      <span class="glyphicon glyphicon-chevron-down"></span>
    <% end %>
  <% end %>
</div>

<% @stats.each_with_index do |stat, index| %>
  <% video = stat.video %>
  <jukapp-row
    youtubeId="<%= video.youtube_id %>"
    title="<%= video.title %>"
    subtitle="<%= pluralize(stat.play_count, "views") %> &bull; <%= "#{time_ago_in_words(stat.played_at)} ago" %>">
    <div class="element primary-action" horizontal layout center center-justified>
      <%= form_tag queue_video_path(youtube_id: video.youtube_id, title: video.title), method: :post, remote: true do %>
        <core-icon icon="add"></core-icon>
      <% end %>
    </div>
    <% if user_signed_in? && ( !local_variables.include?(:hide_favorites) || !hide_favorites ) %>
      <% if favorite?(video.youtube_id) %>
        <div class="secondary-action" horizontal layout center center-justified>
          <%= form_tag favorites_path(youtube_id: video.youtube_id, title: video.title), method: :delete, remote: true do %>
            <paper-icon-button icon="star" class="secondary-button remove-favorite-button"></paper-icon-button>
          <% end %>
        </div>
      <% else %>
        <div class="secondary-action" horizontal layout center center-justified>
          <%= form_tag favorites_path(youtube_id: video.youtube_id, title: video.title), method: :post, remote: true do %>
            <paper-icon-button icon="star-outline" class="secondary-button add-favorite-button"></paper-icon-button>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </jukapp-row>
<% end %>

<script>
  $(function() {
    var eventStream = new EventStream(<%= event_stream_params %>);
    eventStream.forQueue();

    $("jukapp-row").bind( "primary-action", function(e) {
      $(e.target.querySelector(".primary-action form")).submit();
    });

    $(".add-favorite-button").bind("click.addFavorite", function() {
      $(this).closest("form").submit();
      $(this).attr("disabled", "disabled");
      $(this).attr("icon", "star");
    });

    $(".remove-favorite-button").bind("click.removeFavorite", function() {
      $(this).closest("form").submit();
      $(this).attr("disabled", "disabled");
      $(this).attr("icon", "star-outline");
    });

  });
</script>
