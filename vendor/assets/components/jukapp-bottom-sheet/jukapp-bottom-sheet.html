<link rel="import" href="../core-toolbar/core-toolbar.html">
<link rel="import" href="../core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../core-header-panel/core-header-panel.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">

<polymer-element name="jukapp-bottom-sheet" attributes="drawerWidth narrow queue hasDeleteButton">
  <template>

  <style>

  .bottom-sheet {
    position: fixed;
    background: white;
    bottom: 0;
    right: 0;
    max-height: {{ actualHeight }};
  }
  .transition {
    transition: left ease-in-out 0.3s, height ease-in-out 0.3s, max-height ease-in-out 0.3s;
  }
  .bottom-sheet-content {
    height: 100%;
    width: 100%;
  }
  .bottom-sheet-row {
    height: 48px;
    padding-top: 8px;
    padding-bottom: 8px;
  }
  .bottom-sheet-content .element {
    opacity: 0.87;
    padding-left: 16px;
    padding-right: 16px;
    display: inline-block;
  }
  .bottom-sheet-content .small-element {
    width: 24px;
    height: 24px;
  }
  .bottom-sheet-content .last-element {
    opacity: 0.87;
    padding-right: 16px;
    display: inline-block;
  }
  .bottom-sheet-content span.secondary {
    opacity: 0.54;
  }
  paper-button {
    padding: 0px;
    margin: 0px;
    text-align: left;
    text-transform: none;
  }
  paper-button /deep/ .button-content {
    padding: 0px;
  }
  paper-ripple {
    color: #FF5722;
  }

</style>

  <div id="drawer" class="bottom-sheet {{ { 'transition': !dragging } | tokenList }}" vertical layout _style="left: {{ narrow ? '0px' : drawerWidth }}; height: {{ isHidden ? '0px' : fullyExpanded ? actualHeight : rowHeight }}">
    <paper-ripple id="ripple" fit></paper-ripple>
    <div class="bottom-sheet-content">
      <template repeat="{{ video, index in queue }}">
        <div horizontal relative layout flex center>
          <div class="bottom-sheet-row content" on-tap="{{togglePanel}}" horizontal relative layout flex center>
            <template if="{{ isExpandable(index) }}">
              <core-icon icon="{{ fullyExpanded ? 'expand-more' : 'expand-less' }}" class="element small-element"></core-icon>
            </template>
            <template if="{{ !isExpandable(index) }}">
              <span class="element small-element"></span>
            </template>
            <span class="element small-element secondary">{{ index+1 }}</span>
            <span flex>{{ video.title }}</span>
            <span class="element secondary">{{ durationFromSeconds(video.length) }}</span>
          </div>
          <template if="{{ hasDeleteButton }}">
            <div class="bottom-sheet-row button" horizontal relative layout center>
              <paper-icon-button video-id="{{video.id}}" icon="delete" class="element small-element" on-tap="{{deleteTapHandler}}"></paper-icon-button>
            </div>
          </template>
        </div>
      </template>
    </div>
  </div>

</template>
<script>

  Polymer('jukapp-bottom-sheet', {

    publish: {
      dragging: false,
      fullyExpanded: false,
      drawerHeight: "384px",
      rowHeight: "64px",
      queue: [],
      isHidden: true,
      actualHeight: "",
      hasDeleteButton: false
    },

    eventDelegates: {
      trackstart: 'trackStart',
      tracky: 'tracky',
      trackend: 'trackEnd'
    },

    deleteTapHandler: function(e) {
      this.fire("delete-tapped", {id: e.srcElement.getAttribute("video-id")});
    },

    isExpandable: function(index) {
      return index == 0 && this.queue.length != 1;
    },

    queueChanged: function() {

      this.$.ripple.downAction({x:0, y:0});

      setTimeout(function(){
        this.$.ripple.upAction();
      }.bind(this), 200);

      this.isHidden = this.queue.length == 0;

      if (!this.isHidden) {
        queueSize = this.queue.length > 6 ? 6 : this.queue.length;
        this.actualHeight = (queueSize * parseInt(this.rowHeight)) + "px";
      }
    },

    togglePanel: function() {
      this.fullyExpanded = !this.fullyExpanded;
    },

    translateYForDeltaY: function(deltaY) {
      var baseHeight = 64;
      return Math.max(baseHeight, this.drawerStartHeight - deltaY);;
    },

    trackStart: function(e) {
      this.drawerStartHeight = this.$.drawer.offsetHeight;
      this.dragging = true;
      e.preventTap();
    },

    tracky : function(e) {
      this.moveDrawer(this.translateYForDeltaY(e.dy));
    },

    trackEnd: function(e) {
      this.dragging = false;
      if (e.yDirection < 0) {
        this.fullyExpanded = true;
        this.$.drawer.style.height = this.drawerHeight;
      } else {
        this.fullyExpanded = false;
        this.$.drawer.style.height = this.rowHeight;
      }
    },

    moveDrawer: function(translateY) {
      this.$.drawer.style.height = translateY + 'px';
    },

    durationFromSeconds: function(sec)
    {
      var date = new Date(0,0,0);
      date.setSeconds(+sec);
      return date.getMinutes()+':'+(date.getSeconds() < 10 ? '0' : '')+date.getSeconds();
    }

  });

</script>
</polymer-element>
